//
//  GPUImageFacePointFilter.mm
//  StupidCamera
//
//  Created by rayyy on 2021/4/16.
//

#import "GPUImageFacePointFilter.h"
#import "SCFilterBackgroundPoint.hpp"
#include <vector>

#define MAX_SMALL_FACE_DEGREE 0.2

@interface GPUImageFacePointFilter()
{
    SCFilterBackgroundPoint *pointFilter;
}
@property (nonatomic, copy) dispatch_block_t setFacedataBlock;
@end

@implementation GPUImageFacePointFilter

- (instancetype)init {
    if (self = [super init]) {
        _smallFaceDegree = 1.0f;
        runSynchronouslyOnVideoProcessingQueue(^{
            [GPUImageContext useImageProcessingContext];
            self->pointFilter = new SCFilterBackgroundPoint();
            self->pointFilter->init();
        });
    }
    return self;
}

- (void)dealloc {
    runSynchronouslyOnVideoProcessingQueue(^{
        [GPUImageContext useImageProcessingContext];
        self->pointFilter->release();
        delete self->pointFilter;
    });
}

- (void)setupFilterForSize:(CGSize)filterFrameSize;
{
    runSynchronouslyOnVideoProcessingQueue(^{
        [GPUImageContext useImageProcessingContext];
        self->pointFilter->resize(filterFrameSize.width, filterFrameSize.height);
    });
}

- (void)renderToTextureWithVertices:(const GLfloat *)vertices textureCoordinates:(const GLfloat *)textureCoordinates;
{
    if (self.preventRendering)
    {
        [firstInputFramebuffer unlock];
        return;
    }
    
    outputFramebuffer = [[GPUImageContext sharedFramebufferCache] fetchFramebufferForSize:[self sizeOfFBO] textureOptions:self.outputTextureOptions onlyTexture:NO];
    [outputFramebuffer activateFramebuffer];
    if (usingNextFrameForImageCapture)
    {
        [outputFramebuffer lock];
    }
    
    if (_setFacedataBlock) {
        _setFacedataBlock();
    }
    
    [self setFaceDataDict:nil];
    
    self->pointFilter->setSrcTextureID(firstInputFramebuffer.texture);
    self->pointFilter->setOutsideTextureAndFbo(outputFramebuffer.texture, outputFramebuffer.framebuffer);
    self->pointFilter->render();
    
    [firstInputFramebuffer unlock];
    
    if (usingNextFrameForImageCapture)
    {
        dispatch_semaphore_signal(imageCaptureSemaphore);
    }
}

- (void)setFaceDataDict:(NSArray<NSDictionary *> *)faceDataDict {
//    __weak typeof(self) weakSelf = self;
//    _setFacedataBlock = ^{
//        __strong typeof(weakSelf) strongSelf = weakSelf;
//        strongSelf->_faceDataDict = [NSMutableArray arrayWithArray:faceDataDict];
//        if (faceDataDict.count > 0) {
//            NSArray<NSValue *> *facePointsArray = faceDataDict[0][@"facePoints"];
//            if (facePointsArray.count >= 13) {
//                float facePointFloat[26];
//                for (int i = 0; i < 13; i++) {
//                    facePointFloat[2 * i] = facePointsArray[i].CGPointValue.x;
//                    facePointFloat[2 * i + 1] = facePointsArray[i].CGPointValue.y;
//                }
//                float facePointFloatChanged[26];
//                memcpy(facePointFloatChanged, facePointFloat, sizeof(float) * 26);
//                [strongSelf changeSmallFacePoint:facePointFloatChanged];
//                strongSelf->pointFilter->setPoints(facePointFloatChanged, 13);
//            }
//        }
//    };
    std::vector<float> points = {
        0.240767, 0.497225,
        0.247368, 0.534511,
        0.258949, 0.571734,
        0.273712, 0.608918,
        0.295931, 0.644499,
        0.325284, 0.677030,
        0.362258, 0.704829,
        0.404782, 0.727741,
        0.452495, 0.743931,
        0.503906, 0.751465,
        0.555474, 0.745051,
        0.601725, 0.726743,
        0.642057, 0.701772,
        0.674520, 0.670970,
        0.704835, 0.638991,
        0.727301, 0.603556,
        0.741409, 0.566605,
        0.752195, 0.529696,
        0.757927, 0.492849,
        0.273438, 0.417969,
        0.328776, 0.411133,
        0.368490, 0.412598,
        0.407552, 0.417969,
        0.455078, 0.421387,
        0.419271, 0.397949,
        0.371745, 0.391602,
        0.324870, 0.393555,
        0.724609, 0.415039,
        0.679036, 0.409668,
        0.628255, 0.410645,
        0.589193, 0.416016,
        0.541016, 0.419434,
        0.576823, 0.396484,
        0.624349, 0.389648,
        0.682292, 0.393066,
        0.333984, 0.458008,
        0.354167, 0.470215,
        0.379557, 0.474121,
        0.406250, 0.473145,
        0.432943, 0.472168,
        0.412760, 0.452148,
        0.387370, 0.442871,
        0.358724, 0.445801,
        0.383219, 0.461060,
        0.380059, 0.457276,
        0.664714, 0.458008,
        0.644531, 0.470215,
        0.619141, 0.474121,
        0.592448, 0.473145,
        0.565755, 0.472168,
        0.585938, 0.452148,
        0.611328, 0.442871,
        0.639974, 0.445801,
        0.615479, 0.461060,
        0.610108, 0.456901,
        0.470136, 0.470285,
        0.465734, 0.536192,
        0.436843, 0.582322,
        0.463638, 0.592439,
        0.502118, 0.595661,
        0.539982, 0.592481,
        0.566486, 0.582086,
        0.536899, 0.536109,
        0.529622, 0.470591,
        0.503107, 0.562645,
        0.404948, 0.634766,
        0.594401, 0.634277,
        0.430339, 0.654297,
        0.462240, 0.669434,
        0.500000, 0.673340,
        0.538411, 0.670410,
        0.572266, 0.653809,
        0.544356, 0.640485,
        0.499412, 0.644254,
        0.453274, 0.641522,
        0.436849, 0.631348,
        0.472005, 0.626953,
        0.500000, 0.630859,
        0.524740, 0.626953,
        0.557943, 0.629395,
        0.544007, 0.640389,
        0.499405, 0.644718,
        0.453611, 0.641405,
        0.497684, 0.471512,
        0.498047, 0.420410,
        0.499005, 0.612981,
        0.303385, 0.271557,
        0.489209, 0.286128,
        0.688802, 0.273321,
        0.497358, 0.345137,
//
        0.236405, 0.422543, // 90
        0.760493, 0.419268,
        0.625776, 0.269738,
        0.723356, 0.332429,
        0.493899, 0.247993,
        0.363759, 0.272574,
        0.269510, 0.336464,
        -0.010409, 0.006287,
        -0.010409, 0.006287,
        -0.085299, -0.061836,
        -0.075832, 0.567543,
        -0.070153, 0.945148,
        0.508787, 0.940250,
        1.081832, 0.935402,
        1.076152, 0.557797,
        1.066685, -0.071583,
        0.493641, -0.066734,
        0.339330, 0.621842,
        0.660851, 0.618917,
        0.385413, 0.520165,
        0.615600, 0.520047,
        0.289673, 0.455261,
        0.333222, 0.479636,
        0.379994, 0.493763,
        0.427601, 0.482037,
        0.451539, 0.471226,
        0.440407, 0.439712,
        0.386994, 0.425949,
        0.330540, 0.434062,
        0.413700, 0.432830,
        0.358767, 0.430005,
        0.709025, 0.455261,
        0.665883, 0.479108,
        0.619577, 0.493763,
        0.571504, 0.482566,
        0.547689, 0.471380,
        0.557754, 0.440410,
        0.610952, 0.425949,
        0.667620, 0.433364,
        0.584353, 0.433179,
        0.639286, 0.429656,
        0.385413, 0.520165,
        0.615600, 0.520047,
        0.339330, 0.621842,
        0.660851, 0.618917,
        0.693906, 0.509129,
        0.638657, 0.596245,
        0.682913, 0.558213,
        0.566121, 0.527127,
        0.624700, 0.570149,
        0.630013, 0.518128,
        0.738720, 0.497733,
        0.723860, 0.564087,
        0.684982, 0.626167,
        0.501953, 0.712402,
        0.546943, 0.707731,
        0.586995, 0.690276,
        0.618229, 0.668025,
        0.749728, 0.417999,
        0.247515, 0.421171,
        0.495973, 0.334202,
        0.622143, 0.344276,
        0.715024, 0.374948,
        0.371062, 0.346999,
        0.280120, 0.378832,
        0.306342, 0.510652,
        0.361684, 0.597455,
        0.318419, 0.560145,
        0.434893, 0.527245,
        0.377631, 0.571233,
        0.370617, 0.518949,
        0.260439, 0.501253,
        0.276790, 0.568257,
        0.315656, 0.630386,
        0.457367, 0.706682,
        0.417560, 0.691019,
        0.383603, 0.669797,
        0.155128, 0.505796,
        0.163929, 0.555510,
        0.179370, 0.605141,
        0.199054, 0.654719,
        0.228679, 0.702161,
        0.267818, 0.745536,
        0.317116, 0.782601,
        0.373815, 0.813151,
        0.437432, 0.834737,
        0.505980, 0.844782,
        0.574737, 0.836230,
        0.636405, 0.811820,
        0.690181, 0.778525,
        0.733465, 0.737456,
        0.773886, 0.694817,
        0.803840, 0.647571,
        0.822650, 0.598303,
        0.837032, 0.549090,
        0.844674, 0.499962,
        0.149313, 0.406220,
        0.848096, 0.401853,
        0.668473, 0.202479,
        0.798580, 0.286067,
        0.492637, 0.173487,
        0.319117, 0.206262,
        0.193451, 0.291448
    };
    
    std::vector<float> points2 = {
      0.207918, 0.410357,
      0.215353, 0.455589,
      0.226546, 0.500879,
      0.241939, 0.546235,
      0.268519, 0.588549,
      0.302247, 0.631583,
      0.340204, 0.670892,
      0.388283, 0.696739,
      0.440465, 0.713081,
      0.494141, 0.723633,
      0.552096, 0.716500,
      0.608939, 0.703293,
      0.663026, 0.681650,
      0.712361, 0.650761,
      0.754189, 0.610261,
      0.778493, 0.555376,
      0.785147, 0.505576,
      0.787807, 0.455713,
      0.791516, 0.405866,
      0.309570, 0.314941,
      0.348633, 0.312988,
      0.387695, 0.315918,
      0.436523, 0.321289,
      0.467773, 0.309570,
      0.438965, 0.290527,
      0.392578, 0.285645,
      0.348145, 0.289551,
      0.683594, 0.310059,
      0.645020, 0.311523,
      0.608887, 0.311523,
      0.569336, 0.317383,
      0.532715, 0.308105,
      0.564453, 0.289551,
      0.607422, 0.287109,
      0.642090, 0.289062,
      0.328125, 0.380371,
      0.353027, 0.387207,
      0.379883, 0.388672,
      0.406738, 0.387695,
      0.429199, 0.380371,
      0.406738, 0.348145,
      0.381348, 0.339356,
      0.352051, 0.347656,
      0.380859, 0.377441,
      0.379883, 0.376465,
      0.666504, 0.376953,
      0.646484, 0.383789,
      0.624023, 0.387207,
      0.601074, 0.386230,
      0.576660, 0.378418,
      0.601562, 0.346678,
      0.624023, 0.341797,
      0.645996, 0.351074,
      0.625000, 0.377441,
      0.624023, 0.376465,
      0.454590, 0.378906,
      0.466309, 0.430664,
      0.428223, 0.488770,
      0.463867, 0.507324,
      0.502441, 0.517578,
      0.538086, 0.510742,
      0.572754, 0.488281,
      0.530762, 0.431641,
      0.543945, 0.380859,
      0.503418, 0.470215,
      0.414062, 0.586426,
      0.583496, 0.586914,
      0.441895, 0.607910,
      0.469727, 0.620605,
      0.499512, 0.625488,
      0.533691, 0.621582,
      0.562500, 0.609863,
      0.537109, 0.593750,
      0.500000, 0.595703,
      0.460449, 0.593262,
      0.450195, 0.561035,
      0.481445, 0.545898,
      0.500488, 0.557129,
      0.521973, 0.542969,
      0.554688, 0.558594,
      0.539062, 0.581055,
      0.501465, 0.580078,
      0.461426, 0.578613,
      0.499512, 0.380371,
      0.501465, 0.311035,
      0.502441, 0.534668,
      0.275391, 0.159668,
      0.500000, 0.207520,
      0.732422, 0.159668,
      0.498047, 0.257812,
      0.206332, 0.320102,
      0.789761, 0.306030,
      0.644177, 0.158253,
      0.751456, 0.221427,
      0.496670, 0.133436,
      0.352596, 0.156799,
      0.246325, 0.225124,
      0.006012, -0.007768,
      0.006012, -0.007768,
      -0.132915, -0.198549,
      -0.127731, 0.475072,
      -0.123832, 0.981735,
      0.507317, 0.976878,
      1.149890, 0.971933,
      1.145991, 0.465270,
      1.140807, -0.208351,
      0.498234, -0.203406,
      0.328000, 0.566330,
      0.680994, 0.571145,
      0.378174, 0.434571,
      0.619629, 0.432617,
      0.280664, 0.383008,
      0.331618, 0.399125,
      0.379472, 0.414948,
      0.427764, 0.400277,
      0.441895, 0.379638,
      0.434998, 0.332413,
      0.381702, 0.316718,
      0.324297, 0.331048,
      0.408350, 0.324566,
      0.353000, 0.323883,
      0.703858, 0.376514,
      0.665176, 0.394975,
      0.623658, 0.410567,
      0.582041, 0.396825,
      0.560302, 0.379638,
      0.576888, 0.331913,
      0.624338, 0.321672,
      0.671119, 0.337088,
      0.600613, 0.326792,
      0.647729, 0.329380,
      0.378174, 0.434571,
      0.619629, 0.432617,
      0.328000, 0.566330,
      0.680994, 0.571145,
      0.702769, 0.423479,
      0.640987, 0.538783,
      0.698478, 0.490651,
      0.574707, 0.433349,
      0.635616, 0.489466,
      0.638738, 0.428414,
      0.764892, 0.411150,
      0.759146, 0.501098,
      0.720229, 0.588817,
      0.496826, 0.674560,
      0.542893, 0.669041,
      0.585720, 0.656578,
      0.623261, 0.634282,
      0.757911, 0.307238,
      0.237304, 0.318554,
      0.499068, 0.222236,
      0.628953, 0.235114,
      0.723696, 0.266227,
      0.368760, 0.233650,
      0.272948, 0.268905,
      0.288424, 0.428445,
      0.357641, 0.538526,
      0.301220, 0.490625,
      0.428711, 0.434571,
      0.364721, 0.489698,
      0.358568, 0.431508,
      0.232070, 0.415784,
      0.248948, 0.497803,
      0.295256, 0.573542,
      0.455096, 0.666843,
      0.415089, 0.652325,
      0.377133, 0.628659,
      0.110720, 0.420353,
      0.120634, 0.480661,
      0.135557, 0.541048,
      0.156081, 0.601523,
      0.191522, 0.657942,
      0.236493, 0.715320,
      0.287101, 0.767733,
      0.351206, 0.802195,
      0.420783, 0.823984,
      0.492351, 0.838054,
      0.569623, 0.828543,
      0.645415, 0.810934,
      0.717531, 0.782076,
      0.783311, 0.740891,
      0.839082, 0.686891,
      0.871486, 0.613711,
      0.880358, 0.547311,
      0.883906, 0.480827,
      0.888850, 0.414365,
      0.108606, 0.300013,
      0.886511, 0.281249,
      0.692399, 0.084214,
      0.835438, 0.168445,
      0.495723, 0.051125,
      0.303624, 0.082275,
      0.161929, 0.173375,
    };
    if (_smallFaceDegree > 0.5) {
        pointFilter->setPoints(points.data(), points.size() / 2);
    } else {
        pointFilter->setPoints(points2.data(), points2.size() / 2);
    }
}

- (void)setSmallFaceDegree:(float)smallFaceDegree {
    _smallFaceDegree = smallFaceDegree;
}

- (void)changeSmallFacePoint:(float *)facePointFloat {
    facePointFloat[2] += (facePointFloat[0] - facePointFloat[2]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    facePointFloat[3] += (facePointFloat[1] - facePointFloat[3]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    
    facePointFloat[4] -= (facePointFloat[4] - facePointFloat[0]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    facePointFloat[5] += (facePointFloat[1] - facePointFloat[5]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    
    facePointFloat[6] += (facePointFloat[0] - facePointFloat[6]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    facePointFloat[7] -= (facePointFloat[7] - facePointFloat[1]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    
    facePointFloat[8] -= (facePointFloat[8] - facePointFloat[0]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
    facePointFloat[9] -= (facePointFloat[9] - facePointFloat[1]) * MAX_SMALL_FACE_DEGREE * _smallFaceDegree;
}

@end
